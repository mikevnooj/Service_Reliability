---
title: "Daily Service Reliability Report"
author: "Mike Nugent, Jr."
date: '`r gsub(" 0"," ", format(Sys.Date(), "%B %d, %Y"))`'
knit: (function(inputFile, encoding){rmarkdown::render(inputFile,encoding = encoding,output_file = paste0(format(Sys.Date(), "%Y%m%d"), " Service Reliability Report", '.html'))})

#paste this back in later
#"//iptc-prtsvr1/shared/Transportation Management/Service Reliability Reports")})

  
output: 
  html_document:
    df_print: paged
    fig_cap: true
    code_folding: hide
    toc: true
    toc_depth: 2
---

```{r set libraries and options, include=F}

library(data.table)
library(dplyr)
library(kableExtra)
library(scales)
library(lubridate)


knitr::opts_chunk$set(echo = TRUE,message = F)

```

```{r define date variables, include = FALSE}

#dynamic date vars
yesterday_avail <- lubridate::floor_date(Sys.Date() - 1,unit = "day")

#current_month_avail <- floor_date(Sys.Date() - 1,unit= "month")

since_september_avail <- "2019-09-01"

last_month_end_avail <- lubridate::floor_date(Sys.Date(), unit = "month") - 1

last_month_start_avail <- lubridate::rollback(last_month_end_avail, roll_to_first = TRUE, preserve_hms = FALSE)

report_start_time <- Sys.time()

yesterday_full_date <- gsub(" 0", " ", format(yesterday_avail, "%B %d, %Y" ))

last_month_name <- format(last_month_start_Avail, "%B" )

last_week_start_Avail <- lubridate::floor_date(Sys.Date() -7, unit = "week")

last_week_end_Avail <- lubridate::ceiling_date(Sys.Date() - 7, unit = "week") - 1


```
This report presents key service reliability metrics: on-time performance (OTP) and headway adherence. Unless otherwise noted, **this report concerns service provided on `r yesterday_full_date`**.

## OTP

Operators are considered "on-time" if while in revenue service they depart a timepoint within one minute early or five minutes late from the scheduled time of departure.

On-time performance is calculated as the number of on-time depatures divided by the total number of departures for each category (mode, operator, month, etc).

```{r include = FALSE}
knitr::opts_chunk$set(echo=FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)
options(dplyr.summarise.inform = FALSE)
```


```{r get and clean data, results='asis'}
# gather, clean, transform data

# get Avail adherence

con2 <- DBI::dbConnect(odbc::odbc()
                       , Driver = "SQL Server"
                       , Server = "AVAILDWHP01VW"
                       , Database = "DW_IndyGo"
                       , Port = 1433
                       )

  
# get calendar key

DimDate_yesterday <- tbl(con2
                         , "DimDate"
                         ) %>%
  filter(CalendarDate == yesterday_avail) %>%
  collect() %>%
  data.table()

# get month to date calendar key

DimDate_last_month <- tbl(con2
                          , "DimDate"
                          ) %>%
  filter(CalendarDate >= last_month_start_Avail
         , CalendarDate <= last_month_end_Avail
         ) %>%
  collect() %>%
  data.table()

DimDate_last_month_last_day <- max(DimDate_last_month$DateKey)

DimDate_last_month_first_day <- min(DimDate_last_month$DateKey)

# get dates since september

DimDate_since_september <- tbl(con2
                               , "DimDate"
                               ) %>%
  filter(CalendarDate >= since_september_Avail
         , CalendarDate <= yesterday_Avail
         ) %>%
  collect() %>%
  data.table()
  

# get last week calendar key

DimDate_last_week <- tbl(con2
                         , "DimDate"
                         ) %>%
  filter(between(CalendarDate
                 , last_week_start_Avail
                 , last_week_end_Avail
                 )
         ) %>%
  collect()

# get DimPattern

DimPattern <- tbl(con2
                  , "DimPattern"
                  ) %>% collect()

# get routes

DimRoute <- tbl(con2, "DimRoute") %>% collect()

# get vehicles

DimVehicle <- tbl(con2, "DimVehicle") %>% collect()

# get route 90 BRT

DimRoute_90 <- tbl(con2, "DimRoute") %>% 
  filter(RouteDesc == "Red Line") %>%
  collect()

# get stops

DimStop <- tbl(con2, "DimStop") %>%
  collect()

# get time (for hour of day OTP)

DimTime <- tbl(con2, "DimTime") %>% collect()

# get operators 

DimUser <- tbl(con2, "DimUser") %>%
  collect()

# get blocks 

DimBlock <- tbl(con2, "DimBlock") %>%
  collect()

# get trips, for direction

DimTrip <- tbl(con2, "DimTrip") %>%
  select(TripKey, DirectionDesc) %>%
  collect()

# get Avail adherence for yesteday

FactTimepointAdherence_raw <- tbl(con2
                                  , "FactTimepointAdherence"
                                  ) %>%   
  select(-CoordinateList
         , -TimepointGeom
         , everything()
         )%>% #  CoordinateList and TimepointGeom break collection
  filter(DateKey == !!DimDate_yesterday$DateKey
         , !is.na(DepartTimeVarianceSecs)
         ) %>%
  collect()

# # get Avail adherence for whole month
# 
# FactTimepointAdherence_month <- tbl(con2, "FactTimepointAdherence") %>% 
#   select(everything(),-CoordinateList,-TimepointGeom) %>% 
#   filter(DateKey %in% local(DimDate_current_month$DateKey)) %>%
#   collect()

# get data since september, and then join it

FactTimepointAdherence_since_september <- tbl(con2, "FactTimepointAdherence") %>% 
  select(DateKey, PatternKey, RouteKey, UserKey, DepartStopKey, DepartTimeVarianceSecs, -CoordinateList,-TimepointGeom) %>% 
  filter(DateKey %in% local(DimDate_since_september$DateKey),
         !is.na(DepartTimeVarianceSecs)) %>%
  collect()

# consider only getting relevant fields--but note, anti-joins would have to be fixed, most likely.

# FactTimepointAdherence_since_september <- tbl(con2, "FactTimepointAdherence") %>% 
#   select(DateKey, DepartStopKey, PatternKey,DepartTimeVarianceSecs, RouteKey, -CoordinateList,-TimepointGeom) %>% 
#   filter(DateKey %in% local(DimDate_since_september$DateKey)) %>%
#   collect()

# join

FactTimepointAdherence_since_september_joined <- FactTimepointAdherence_since_september  %>%
  left_join(DimStop, by = c("DepartStopKey" = "StopKey")) %>%
  left_join(select(DimDate_since_september, DateKey, CalendarDate), by = "DateKey")

# set route 90 OTP

FactTimepointAdherence_90 <- FactTimepointAdherence_raw %>% 
  filter(RouteKey %in% local(DimRoute_90$RouteKey))

# join stops

FactTimepointAdherence_joined <- FactTimepointAdherence_90 %>%
  left_join(DimStop, by = c("DepartStopKey" = "StopKey")) %>%
  left_join(select(DimDate_yesterday, DateKey, CalendarDate), by = "DateKey")

# date/data check

# nrow(FactTimepointAdherence_since_september_joined)
# 
# sort(unique(FactTimepointAdherence_since_september_joined$CalendarDate))
# 
# nrow(FactTimepointAdherence_raw )

# set index for September data

FactTimepointAdherence_since_september_joined$index <- 1:nrow(FactTimepointAdherence_since_september_joined)

FactTimepointAdherence_since_september$index <- 1:nrow(FactTimepointAdherence_since_september)

```